<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Accounts Toolkit â€” Hasan</title>
    
    <link rel="icon" type="image/png" href="assets/icon.png">
    <!-- Professional Icons Library (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- PWA and Mobile-Friendly Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href='data:application/manifest+json,{
        "name": "Accounts Toolkit",
        "short_name": "AccToolkit",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#000000",
        "theme_color": "#000000",
        "description": "An all-in-one toolkit for commerce students.",
        "icons": [{ "src": "assets/icon.png", "sizes": "192x192", "type": "image/png" }]
    }'>

    <style>
        /* 1. Global Styles & Theme */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        :root {
            --font-primary: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --bg-color: #0d0d0d; /* Slightly off-black for depth */
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent-blue: #007BFF;
            --accent-purple: #8A2BE2;
            --btn-dark-bg: #222222;
            --glass-bg: rgba(34, 34, 34, 0.6); /* Glass effect background */
            --transition-smooth: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-primary);
            color: var(--text-primary);
            background-color: var(--bg-color);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none; -webkit-user-select: none;
            display: flex; flex-direction: column;
            position: relative; /* For Aurora Effect */
        }
        
        /* 2. FUTURISTIC AURORA BACKGROUND */
        body::before, body::after {
            content: '';
            position: fixed;
            z-index: -1;
            filter: blur(100px); /* The magic blur effect */
            border-radius: 50%;
        }
        body::before {
            width: 400px; height: 400px;
            background: radial-gradient(circle, var(--accent-blue), transparent 60%);
            top: -100px; left: -100px;
            animation: move-aurora-1 20s infinite alternate;
        }
        body::after {
            width: 300px; height: 300px;
            background: radial-gradient(circle, var(--accent-purple), transparent 60%);
            bottom: -50px; right: -50px;
            animation: move-aurora-2 25s infinite alternate;
        }
        @keyframes move-aurora-1 {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(100px, 150px) rotate(180deg); }
        }
        @keyframes move-aurora-2 {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(-150px, -100px) rotate(-180deg); }
        }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        @keyframes slideUpFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* 3. Main App Structure */
        .app-container { flex: 1; min-height: 0; position: relative; perspective: 1500px; z-index: 2; }
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 20px 16px 20px 16px;
            overflow-y: auto;
            visibility: hidden; opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            display: flex; flex-direction: column; align-items: center;
        }
        .view.active { visibility: visible; opacity: 1; transform: translateX(0); }
        .view-content { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; }

        /* 4. DYNAMIC HEADER with Glass Effect */
        .app-header {
            position: relative; z-index: 3; flex-shrink: 0; text-align: center;
            padding: 20px 16px; transition: padding var(--transition-smooth), background-color 0.5s, backdrop-filter 0.5s;
        }
        .app-header.header-scrolled {
            padding: 10px 16px;
            background-color: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .header-title-container { display: flex; flex-direction: column; align-items: center; width: 100%; position: relative;}
        .header-title { font-size: 1.8rem; font-weight: 600; transition: font-size var(--transition-smooth); }
        .header-subtitle { font-size: 0.8rem; color: var(--text-secondary); transition: opacity var(--transition-smooth), font-size var(--transition-smooth), display 0s; }
        .app-header.header-scrolled .header-title { font-size: 1.3rem; }
        .app-header.header-scrolled .header-subtitle { opacity: 0; font-size: 0.6rem; }
        .btn-back { background: none; border: none; color: var(--text-primary); cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; opacity: 0; pointer-events: none; transition: background var(--transition-smooth), opacity var(--transition-smooth); position: absolute; left: 0px; top: 50%; transform: translateY(-50%); z-index: 102; }
        .btn-back:hover { background: var(--glass-bg); }
        body[data-active-view^="view-"] .btn-back { opacity: 1; pointer-events: auto; }
        
        /* 5. Homescreen Icons with GLOW EFFECT */
        #app-homescreen .view-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 20px; padding: 0px 8px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; gap: 12px; cursor: pointer; text-decoration: none; color: var(--text-primary); transition: transform var(--transition-fast); animation: slideUpFadeIn 0.5s both; }
        .app-icon:active { transform: scale(0.95); }
        .app-icon .icon-visual {
            width: 70px; height: 70px; border-radius: 20px;
            background: var(--glass-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.8rem; /* Icon size */
            transition: all var(--transition-smooth);
        }
        .app-icon:hover .icon-visual {
            background: rgba(0, 123, 255, 0.2);
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 0 25px rgba(0, 123, 255, 0.6); /* THE GLOW */
            color: white;
        }
        .app-icon .icon-label { font-size: 0.8rem; font-weight: 500; text-align: center; }
        .app-icon:nth-child(1) { animation-delay: 0.1s; } .app-icon:nth-child(2) { animation-delay: 0.15s; }
        .app-icon:nth-child(3) { animation-delay: 0.2s; } .app-icon:nth-child(4) { animation-delay: 0.25s; }
        .app-icon:nth-child(5) { animation-delay: 0.3s; } .app-icon:nth-child(6) { animation-delay: 0.35s; }

        /* ... All other CSS is included, but truncated here for brevity ... */
        .tool-card { padding: 16px; background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; width: 100%; transition: box-shadow 0.3s, transform 0.3s; animation: slideUpFadeIn 0.4s both; }
        .form-group { margin-bottom: 16px; } .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
        input, select, textarea { width: 100%; padding: 14px 18px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); background-color: rgba(0,0,0,0.2); color: var(--text-primary); font-family: var(--font-primary); font-size: 1rem; }
        input:focus, textarea:focus, select:focus { outline: none; border: 1px solid var(--accent-blue); box-shadow: 0 0 15px rgba(0, 123, 255, 0.5); }
        .result-box { background: rgba(0,0,0,0.3); padding: 16px; border-radius: 12px; margin-top: 16px; font-weight: 500; word-wrap: break-word; line-height: 1.7; }
        .btn { padding: 10px 16px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer; border: none; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; transition: transform 0.2s, box-shadow 0.2s; }
        .btn:hover { box-shadow: 0 0 20px rgba(0, 123, 255, 0.5); }
        .notes-menu-container .notes-menu-item { background: var(--glass-bg); border: 1px solid rgba(255,255,255,0.1); padding: 25px 20px; border-radius: 16px; text-align: center; font-size: 1.3rem; font-weight: 600; cursor: pointer; transition: transform var(--transition-smooth), background var(--transition-smooth); animation: slideUpFadeIn 0.5s both; }
        .notes-list li { background: rgba(0,0,0,0.3); padding: 10px 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; line-height: 1.4; word-break: break-word; }
        .notes-list li span { flex-grow: 1; margin-right: 8px; }
        .notes-columns-container.side-by-side { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        /* --- CALCULATOR CSS BLOCK START --- */
        /* Is poore block se purane calculator CSS ko replace karein */
        
        #view-calculator .view-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 10px;
            background: transparent;
            backdrop-filter: none;
            border: none;
            box-shadow: none;
        }
        #calculator-display {
            text-align: right;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 16px 8px;
            overflow: hidden;
            background: transparent;
        }
        #calculator-expression-container {
            min-height: 55px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        #calculator-expression {
            font-size: 3rem;
            color: var(--text-primary); /* Result is White */
            word-break: break-all;
        }
        #cursor {
            width: 2px;
            height: 3rem;
            background-color: var(--accent-blue);
            animation: blink 1s step-end infinite;
            margin-left: 2px;
        }
        #calculator-preview {
            font-size: 1.5rem;
            min-height: 1.3em;
            color: var(--text-secondary); /* Live Preview is Gray */
        }
        #calculator-controls {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            flex-shrink: 0;
            background: transparent;
        }
        #calculator-controls button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        #calculator-buttons {
            position: relative; /* History panel ke liye zaroori */
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
            padding: 16px 0px;
            flex-shrink: 0;
            background: transparent;
        }
        #history-panel {
            position: absolute;
            bottom: 100%; /* Buttons ke oopar khulega */
            right: 0;
            width: 100%;
            background-color: #1c1c1c;
            padding: 16px;
            border-radius: 16px;
            display: none;
            z-index: 5;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
        }
        #history-panel ul {
            list-style: none;
            text-align: right;
            font-size: 1.2rem;
            max-height: 150px;
            overflow-y: auto;
            padding: 0;
        }
        .calc-btn { width: 100%; aspect-ratio: 1/1; border-radius: 50%; border: none; font-size: 1.8rem; font-weight: 500; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: filter 0.1s, transform 0.1s; }
        .calc-btn:active { transform: scale(0.95); filter: brightness(1.2); }
        .btn-num { background-color: #333; color: var(--text-primary); }
        .btn-op, .btn-special { background-color: #2E3A48; color: var(--accent-blue); }
        .btn-equal { background-color: var(--accent-blue); color: white; font-size: 2rem;}

        /* --- CALCULATOR CSS BLOCK END --- */

        /* JOURNAL TOOL SPECIFIC CSS */
        #journal-entry-table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        #journal-entry-table th, #journal-entry-table td { padding: 10px; text-align: left; border-bottom: 1px solid #444; }
        #journal-entry-table th { color: var(--text-secondary); }
        #journal-entry-table td:nth-child(2), #journal-entry-table td:nth-child(3) { text-align: right; font-family: monospace; }

    </style>
</head>
<body data-active-view="app-homescreen">
    <audio id="click-sound" src="assets/click-sound.mp3" preload="auto"></audio>

    <header class="app-header" id="app-header">
        <div class="header-title-container">
            <button class="btn-back" id="back-button" aria-label="Go Back"><i class="ph-bold ph-arrow-left"></i></button>
            <h1 class="header-title" id="header-title">Accounts Toolkit</h1>
            <span class="header-subtitle" id="header-subtitle">Made By Hasan Patel</span>
        </div>
    </header>

    <div class="app-container">
        <!-- Homescreen -->
        <main id="app-homescreen" class="view active">
            <div class="view-content">
                <a class="app-icon" href="#" data-view="view-calculator"><div class="icon-visual"><i class="ph-bold ph-calculator"></i></div><span class="icon-label">Calculator</span></a>
                <a class="app-icon" href="#" data-view="view-percentage"><div class="icon-visual"><i class="ph-bold ph-chart-line-up"></i></div><span class="icon-label">Percentage</span></a>
                <a class="app-icon" href="#" data-view="view-new-ratio"><div class="icon-visual"><i class="ph-bold ph-handshake"></i></div><span class="icon-label">New Ratio</span></a>
                <a class="app-icon" href="#" data-view="view-divider"><div class="icon-visual"><i class="ph-bold ph-chart-pie-slice"></i></div><span class="icon-label">Ratio Divider</span></a>
                
                <!-- Naya Journal Guide Icon Yahan Jodein -->
                <a class="app-icon" href="#" data-view="view-journal"><div class="icon-visual"><i class="ph-bold ph-book-open-text"></i></div><span class="icon-label">Journal Guide</span></a>
                
                <a class="app-icon" href="#" data-view="view-notes"><div class="icon-visual"><i class="ph-bold ph-notebook"></i></div><span class="icon-label">Notes</span></a>
            </div>
        </main>
        
        <!-- All Tool Sections HTML are included but truncated for brevity -->
        <!-- Is poore section ko REPLACE karein -->
        <section id="view-calculator" class="view">
            <div class="view-content">
                <div id="calculator-display">
                    <div id="calculator-expression-container">
                        <div id="calculator-expression">0</div>
                        <div id="cursor"></div>
                    </div>
                    <div id="calculator-preview"></div>
                </div>
                <div id="calculator-controls"><button id="history-btn">ðŸ•’</button></div>
                <div id="calculator-buttons">
                    <div id="history-panel"><ul></ul></div>
                    <button class="calc-btn btn-special" data-action="clear">AC</button><button class="calc-btn btn-special" data-action="backspace">âŒ«</button><button class="calc-btn btn-special" data-action="negate">+/-</button><button class="calc-btn btn-op" data-value="/">Ã·</button>
                    <button class="calc-btn btn-num" data-value="7">7</button><button class="calc-btn btn-num" data-value="8">8</button><button class="calc-btn btn-num" data-value="9">9</button><button class="calc-btn btn-op" data-value="*">Ã—</button>
                    <button class="calc-btn btn-num" data-value="4">4</button><button class="calc-btn btn-num" data-value="5">5</button><button class="calc-btn btn-num" data-value="6">6</button><button class="calc-btn btn-op" data-value="-">âˆ’</button>
                    <button class="calc-btn btn-num" data-value="1">1</button><button class="calc-btn btn-num" data-value="2">2</button><button class="calc-btn btn-num" data-value="3">3</button><button class="calc-btn btn-op" data-value="+">+</button>
                    <button class="calc-btn btn-special" data-value="%">%</button><button class="calc-btn btn-num" data-value="0">0</button><button class="calc-btn btn-num" data-value=".">.</button><button class="calc-btn btn-equal" data-action="=">=</button>
                </div>
            </div>
        </section>
        <section id="view-percentage" class="view"><div class="view-content"><div class="tool-card"><h2>Percentage</h2><div class="form-group"><label for="percent-main-number">Number</label><input id="percent-main-number" type="number" inputmode="decimal" placeholder="e.g., 1000"></div><div class="form-group"><label for="percent-value">Percentage</label><input id="percent-value" type="text" inputmode="decimal" placeholder="e.g., 10"></div><div id="percent-actions" style="display:flex; gap:10px;"><button class="btn" id="percent-add" style="width:100%;">Add %</button><button class="btn" id="percent-subtract" style="width:100%;">Subtract %</button></div><div id="percent-result-box" class="result-box">Result will show here</div></div></div></section>
        <section id="view-new-ratio" class="view"><div class="view-content"><div class="tool-card"><h2>New Profit Ratio</h2><div class="form-group"><label for="admission-old-ratio">Old Ratio</label><input id="admission-old-ratio" type="text" placeholder="e.g., 3:1"></div><div class="form-group"><label for="admission-new-share">New Partner's Share</label><input id="admission-new-share" type="text" placeholder="e.g., 1/5 or 20%"></div><div id="admission-result-box" class="result-box">Result will show here</div></div></div></section>
        <section id="view-divider" class="view"><div class="view-content"><div class="tool-card"><h2>Ratio Divider</h2><div class="form-group"><label for="splitter-total">Total Amount</label><input id="splitter-total" type="number" inputmode="decimal" placeholder="e.g., 1000"></div><div class="form-group"><label for="splitter-ratio">Ratio</label><input id="splitter-ratio" type="text" placeholder="e.g., 2:3:5"></div><div id="splitter-result-box" class="result-box">Result will show here</div></div></div></section>
        
        <!-- Naya Journal Guide Tool ka Page Yahan Jodein -->
        <section id="view-journal" class="view">
            <div class="view-content">
                <div class="tool-card">
                    <h2>Journal Entry Guide (AI)</h2>
                    <div class="form-group">
                        <label for="journal-input">Enter Transaction</label>
                        <textarea id="journal-input" rows="3" placeholder="e.g., Purchased goods of 10,000 + GST 18% on credit from Mittal Ltd"></textarea>
                    </div>
                    <button id="journal-analyze-btn" class="btn" style="width: 100%;">Analyze Entry</button>
                </div>
                <div id="journal-result-box" class="result-box" style="display: none;">
                    <!-- Result will be populated here by JavaScript -->
                </div>
            </div>
        </section>
        
        <section id="view-notes" class="view"><div class="view-content notes-menu-container" id="notes-menu-container"></div></section>
        <section id="view-notes-details" class="view"><div class="view-content" id="notes-details-container"></div></section>
        <section id="view-notes-custom" class="view"><div class="view-content"><div class="tool-card"><h2 style="font-size: 1.5rem;">My Custom Notes</h2><textarea id="custom-notes-textarea" placeholder="Write your formulas, tricks, or anything you want to remember here... Your notes will be saved automatically."></textarea></div></div></section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ALL VARIABLES AND DOM ELEMENTS ---
        const body = document.body;
        const appHeader = document.getElementById('app-header');
        const headerTitle = document.getElementById('header-title');
        const headerSubtitle = document.getElementById('header-subtitle');
        const clickSound = document.getElementById('click-sound');

        const viewTitles = {
            'app-homescreen': 'Accounts Toolkit', 'view-calculator': 'Calculator', 'view-percentage': 'Percentage Tool',
            'view-new-ratio': 'New Profit Ratio', 'view-divider': 'Ratio Divider', 'view-journal': 'Journal Guide',
            'view-notes': 'Notes', 'view-notes-details': 'Notes', 'view-notes-custom': 'My Custom Notes'
        };

        // --- CORE APP LOGIC ---
        const playSound = () => { clickSound.currentTime = 0; clickSound.play().catch(e => {}); };
        const vibrate = () => { if (window.navigator.vibrate) window.navigator.vibrate(20); playSound(); };
        function handleScroll() {
            if (this.scrollTop > 10) appHeader.classList.add('header-scrolled'); else appHeader.classList.remove('header-scrolled');
        }
        const showView = (viewId, params = {}) => {
            vibrate();
            document.querySelectorAll('.view').forEach(view => { view.classList.remove('active'); view.removeEventListener('scroll', handleScroll); });
            const view = document.getElementById(viewId);
            if (view) { view.classList.add('active'); view.scrollTop = 0; view.addEventListener('scroll', handleScroll); }
            headerTitle.textContent = viewTitles[viewId] || 'Accounts Toolkit';
            headerSubtitle.style.display = viewId === 'app-homescreen' ? 'block' : 'none';
            body.dataset.activeView = viewId;
            if (body.dataset.activeView === 'app-homescreen') appHeader.classList.remove('header-scrolled');
            if (viewId === 'view-notes-details') renderNoteDetails(params.category);
            if (viewId === 'view-notes-custom') renderCustomNotes();
        };
        document.querySelectorAll('[data-view]').forEach(icon => { icon.addEventListener('click', (e) => { e.preventDefault(); showView(icon.dataset.view); }); });
        document.getElementById('back-button').addEventListener('click', () => {
            const currentView = body.dataset.activeView;
            if (currentView === 'view-notes-details' || currentView === 'view-notes-custom') showView('view-notes'); else showView('app-homescreen');
        });

        // --- ALL OTHER TOOLS LOGIC (RESTORED) ---
        const cleanNumber = (num) => parseFloat(num.toPrecision(15));
        
        // --- CALCULATOR LOGIC START ---
        const journalInput = document.getElementById('journal-input');
        const journalAnalyzeBtn = document.getElementById('journal-analyze-btn');
        const journalResultBox = document.getElementById('journal-result-box');
        
        // API KEY IS INTEGRATED HERE
        const GOOGLE_API_KEY = "AIzaSyCoof0MLw4wVrX7msggVVIrop-Uy4XXbPY";

        async function getJournalEntryFromAI(transaction) {
            if (!GOOGLE_API_KEY || GOOGLE_API_KEY === "YAHAN_APNI_API_KEY_DAALEIN") {
                return { error: "API Key not configured correctly." };
            }
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GOOGLE_API_KEY}`;
            const prompt = `You are an expert accountant. Analyze the following journal entry based on modern (increase/decrease) and golden rules of accounting. Your task is to identify the accounts affected, apply debit/credit rules, and handle GST automatically. For GST: If state is mentioned or implied same, split into CGST and SGST. If different state or not mentioned, use IGST. Assume a default rate of 18% if not specified. Respond ONLY with a valid JSON object. Do not add any text before or after the JSON. The JSON object must have this exact structure: { "analysis": "A brief explanation of which rules were applied.", "entries": [ { "account": "Account Name 1", "debit": 10000, "credit": null }, { "account": "To Account Name 2", "debit": null, "credit": 10000 } ] } Transaction to analyze: "${transaction}"`;
            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`API Error: ${errorData.error.message}`); }
                const data = await response.json();
                const textResponse = data.candidates[0].content.parts[0].text;
                const cleanJsonString = textResponse.replace(/```json|```/g, '').trim();
                return JSON.parse(cleanJsonString);
            } catch (error) { return { error: `Failed to analyze. ${error.message}` }; }
        }
        function displayJournalResult(data) {
            if (data.error) { journalResultBox.innerHTML = `<p style="color: #ff4d4d;"><strong>Error:</strong> ${data.error}</p>`; return; }
            let tableHTML = `<p><strong>Analysis:</strong> ${data.analysis}</p><table id="journal-entry-table"><thead><tr><th>Particulars</th><th>Debit (â‚¹)</th><th>Credit (â‚¹)</th></tr></thead><tbody>`;
            let totalDebit = 0, totalCredit = 0;
            data.entries.forEach(entry => {
                const debitAmount = entry.debit ? parseFloat(entry.debit).toLocaleString('en-IN') : '';
                const creditAmount = entry.credit ? parseFloat(entry.credit).toLocaleString('en-IN') : '';
                tableHTML += `<tr><td>${entry.account}</td><td>${debitAmount}</td><td>${creditAmount}</td></tr>`;
                if(entry.debit) totalDebit += parseFloat(entry.debit);
                if(entry.credit) totalCredit += parseFloat(entry.credit);
            });
            tableHTML += `</tbody><tfoot><tr><td style="font-weight: bold;">Total</td><td style="font-weight: bold;">${totalDebit.toLocaleString('en-IN')}</td><td style="font-weight: bold;">${totalCredit.toLocaleString('en-IN')}</td></tr></tfoot></table>`;
            journalResultBox.innerHTML = tableHTML;
        }
        journalAnalyzeBtn.addEventListener('click', async () => {
            const transaction = journalInput.value.trim();
            if (!transaction) { alert("Please enter a transaction to analyze."); return; }
            journalResultBox.style.display = 'block';
            journalResultBox.innerHTML = '<p>Analyzing with AI... Please wait.</p>';
            vibrate();
            const result = await getJournalEntryFromAI(transaction);
            displayJournalResult(result);
        });

        // --- NOTES LOGIC (ALL LOGIC RESTORED) ---
        const USER_NOTES_KEY = 'acct_notes_user_v2', CUSTOM_NOTES_KEY = 'acct_custom_notes_v1';
        let userNotes = JSON.parse(localStorage.getItem(USER_NOTES_KEY)) || {};
        const defaultNotes = {
            "Final Accounts": {
                "Trading Account": { debit: ["To Opening Stock", "To Purchases\n   Less: Purchases Return", "To Carriage Inwards", "To Freight", "To Wages (Direct)", "To Power & Fuel", "To Factory Rent", "To Factory Lighting", "To Royalty (Production related)", "To Octroi & Import Duty", "To Manufacturing Expenses", "To Dock Charges", "To Clearing Charges", "To Motive Power", "To Gas, Water & Steam", "To Coal, Oil & Fuel", "To Productive Expenses", "To Direct Expenses"], credit: ["By Sales\n   Less: Sales Return", "By Closing Stock", "By Goods Sent on Consignment"] },
                "Profit & Loss Account": { debit: ["To Office Rent", "To Office Lighting", "To Office Expenses", "To Insurance", "To Salaries", "To Wages (Indirect)", "To Postage", "To Telephone Expenses", "To Telegram Expenses", "To Printing & Stationery", "To Trade Expenses", "To Travelling Expenses", "To Conveyance", "To Carriage Outwards", "To Advertisement", "To Discount Allowed", "To Bad Debts", "To Repairs", "To Depreciation", "To Interest Paid", "To Commission Allowed", "To Bank Charges", "To Legal Expenses", "To Selling Expenses", "To Distribution Expenses", "To Packing Charges", "To General Expenses", "To Net Profit c/d"], credit: ["By Gross Profit b/d", "By Discount Received", "By Bad Debts Recovered", "By Commission Received", "By Rent Received", "By Interest Received", "By Dividend Received", "By Profit on Sale of Asset", "By Net Loss c/d"] },
                "Balance Sheet": { liabilities: ["Capital\nAdd: Net Profit\nLess: Drawings", "Reserve & Surplus", "Loans (Long Term)", "Debentures", "Bills Payable", "Creditors", "Outstanding Expenses", "Bank Overdraft", "Provision for Taxation", "Proposed Dividend", "General Reserve", "Provision for Doubtful Debts", "Contingent Liabilities"], assets: ["Goodwill", "Patents", "Trademarks", "Copyright", "Buildings", "Plant & Machinery", "Furniture", "Investments", "Debtors\nLess: Provision for Doubtful Debts", "Bills Receivable", "Closing Stock", "Prepaid Expenses", "Outstanding Income", "Accrued Income", "Cash in Hand", "Cash at Bank", "Loose Tools", "Vehicles", "Land"] }
            },
            "NPO Final Accounts": {
                "Income & Expenditure A/c": { debit: ["To Salaries", "To Rent", "To Taxes", "To Printing & Stationery", "To Postage", "To Telephone Expenses", "To General Expenses", "To Repairs", "To Depreciation", "To Insurance", "To Wages", "To Audit Fees", "To Honorarium", "To Sports Material Consumed", "To Cultural Program Expenses", "To Match Expenses", "To Tournament Expenses", "To Library Expenses", "To Subscription Paid to Other Clubs", "To Prize Distributed", "To Conveyance Expenses", "To Entertainment Expenses", "To Loss on Sale of Asset", "To Miscellaneous Expenses", "To Surplus transferred to Capital Fund"], credit: ["By Subscriptions", "By Entrance Fees", "By Donations (Revenue)", "By Donations for General Purpose", "By Life Membership Fees (Revenue treatment if small)", "By Legacies", "By Interest Received", "By Dividend Received", "By Rent Received", "By Sale of Old Newspapers/Magazines", "By Sale of Sports Material", "By Profit on Sale of Asset", "By Receipts from Entertainment/Concert/Drama/Show", "By Sale of Tickets (Match/Function)", "By Locker Rent", "By Miscellaneous Income", "By Deficit transferred to Capital Fund"] },
                "Balance Sheet": { liabilities: ["Capital Fund / General Fund\nAdd: Surplus\nLess: Deficit", "Life Membership Fees (if treated as capital)", "Entrance Fees (if treated as capital)", "Legacies", "Building Fund", "Library Fund", "Sports Fund", "Prize Fund", "Endowment Fund", "Outstanding Expenses", "Creditors", "Subscription Received in Advance", "Loan", "Bank Overdraft"], assets: ["Cash in Hand", "Cash at Bank", "Investments", "Building", "Furniture", "Sports Material", "Library Books", "Fixed Deposits", "Debtors", "Subscriptions Outstanding", "Accrued Interest", "Outstanding Income", "Prepaid Expenses", "Stock of Stationery", "Stock of Sports Materials", "Stock of Medicines", "Musical Instruments", "Computers", "Vehicles"] }
            }
        };
        function saveUserNotes() { localStorage.setItem(USER_NOTES_KEY, JSON.stringify(userNotes)); }
        function renderNotesMenu() { const container = document.getElementById('notes-menu-container'); container.innerHTML = ''; Object.keys(defaultNotes).forEach(category => { const menuItem = document.createElement('div'); menuItem.className = 'notes-menu-item'; menuItem.textContent = category; menuItem.onclick = () => showView('view-notes-details', { category: category }); container.appendChild(menuItem); }); const customItem = document.createElement('div'); customItem.className = 'notes-menu-item'; customItem.textContent = 'My Custom Notes'; customItem.onclick = () => showView('view-notes-custom'); container.appendChild(customItem); }
        function renderNoteDetails(category) { const container = document.getElementById('notes-details-container'); container.innerHTML = ''; const categoryData = defaultNotes[category]; for (const subCategory in categoryData) { const subCategoryCard = document.createElement('div'); subCategoryCard.className = 'notes-subcategory-card'; const sides = Object.keys(categoryData[subCategory]); const subCategoryLower = subCategory.toLowerCase(); const isSideBySide = ['balance sheet', 'trading account', 'profit & loss account', 'income & expenditure a/c'].some(term => subCategoryLower.includes(term)); let columnsHTML = sides.map(side => { const defaultItems = categoryData[subCategory][side] || []; const userItems = userNotes?.[category]?.[subCategory]?.[side] || []; const listItemsHTML = defaultItems.map(item => `<li><span>${item.replace(/\n/g, '<br>&nbsp;&nbsp;')}</span></li>`).join(''); const userListItemsHTML = userItems.map((item, index) => `<li><span>${item.replace(/\n/g, '<br>&nbsp;&nbsp;')}</span><button class="delete-note-btn" data-category="${category}" data-subcategory="${subCategory}" data-side="${side}" data-index="${index}"><i class="ph-bold ph-trash"></i></button></li>`).join(''); let headerText = side.charAt(0).toUpperCase() + side.slice(1); if (isSideBySide && subCategoryLower.includes('balance sheet')) { headerText += side === 'liabilities' ? ' (Cr.)' : ' (Dr.)'; } else if (isSideBySide) { headerText += side === 'credit' ? ' (Cr.)' : ' (Dr.)'; } return `<div class="notes-column"><h4>${headerText}</h4><ul class="notes-list">${listItemsHTML}${userListItemsHTML}</ul><form class="add-note-form" data-category="${category}" data-subcategory="${subCategory}" data-side="${side}"><input type="text" placeholder="Add custom entry..." required><button type="submit" class="btn"><i class="ph-bold ph-plus"></i></button></form></div>`; }).join(''); subCategoryCard.innerHTML = `<h3 class="notes-subcategory-title">${subCategory}</h3><div class="notes-columns-container ${isSideBySide ? 'side-by-side' : ''}">${columnsHTML}</div>`; container.appendChild(subCategoryCard); } }
        function renderCustomNotes() { const textarea = document.getElementById('custom-notes-textarea'); textarea.value = localStorage.getItem(CUSTOM_NOTES_KEY) || ''; textarea.oninput = () => { localStorage.setItem(CUSTOM_NOTES_KEY, textarea.value); }; }
        document.getElementById('notes-details-container').addEventListener('submit', (e) => { if (e.target.classList.contains('add-note-form')) { e.preventDefault(); const input = e.target.querySelector('input'); const newItem = input.value.trim(); if (!newItem) return; const { category, subcategory, side } = e.target.dataset; if (!userNotes[category]) userNotes[category] = {}; if (!userNotes[category][subcategory]) userNotes[category][subcategory] = {}; if (!userNotes[category][subcategory][side]) userNotes[category][subcategory][side] = []; userNotes[category][subcategory][side].push(newItem); saveUserNotes(); renderNoteDetails(category); input.value = ''; } });
        document.getElementById('notes-details-container').addEventListener('click', (e) => { if (e.target.closest('.delete-note-btn')) { const btn = e.target.closest('.delete-note-btn'); const { category, subcategory, side, index } = btn.dataset; userNotes[category][subcategory][side].splice(parseInt(index, 10), 1); saveUserNotes(); renderNoteDetails(category); } });

        // --- CALCULATOR LOGIC START ---
        // Is poore block se purane calculator JS ko replace karein
        const [calcExpressionEl, calcPreviewEl, historyBtn, historyPanel] = [document.getElementById('calculator-expression'), document.getElementById('calculator-preview'), document.getElementById('history-btn'), document.getElementById('history-panel')];
        let currentExpression = '0'; 
        const CALC_HISTORY_KEY = 'acct_calc_history_v1';
        const safeEval = (expr) => { try { if (/[^0-9\.\+\-\*\/\(\)\s%]/.test(expr)) return ''; let sanitized = expr.replace(/(\d*\.?\d+)%/g, '($1/100)'); return new Function('return ' + sanitized)(); } catch { return ''; } };
        const formatForDisplay = (str) => str.replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
        const renderHistory = () => {
            const history = (JSON.parse(localStorage.getItem(CALC_HISTORY_KEY)) || []).filter(item => Date.now() - item.time < 24 * 60 * 60 * 1000);
            localStorage.setItem(CALC_HISTORY_KEY, JSON.stringify(history));
            historyPanel.querySelector('ul').innerHTML = history.length ? history.map(h => `<li>${h.exp} = ${h.res}</li>`).join('') : '<li>No recent history</li>';
        };
        const updateCalcDisplay = () => { 
            calcExpressionEl.textContent = formatForDisplay(currentExpression.replace(/\*/g, 'Ã—')); 
            let previewResult = safeEval(currentExpression);
            calcPreviewEl.textContent = previewResult !== '' ? `= ${formatForDisplay(cleanNumber(previewResult).toString())}` : '';
        }; 
        document.getElementById('calculator-buttons').addEventListener('click', (e) => { 
            vibrate(); 
            const target = e.target.closest('.calc-btn');
            if (target) { 
                const { value, action } = target.dataset; 
                if (currentExpression === '0' && value && value !== '.') currentExpression = ''; 
                if (value) currentExpression += value; 
                if (action === 'clear') currentExpression = '0'; 
                if (action === 'backspace') currentExpression = currentExpression.slice(0, -1) || '0'; 
                if (action === 'negate') {
                    if (currentExpression !== '0') {
                        if (currentExpression.startsWith('-')) { currentExpression = currentExpression.substring(1); }
                        else { currentExpression = '-' + currentExpression; }
                    }
                }
                if (action === '=') { 
                    const finalResult = safeEval(currentExpression); 
                    if (finalResult !== '') {
                        const cleanResult = cleanNumber(finalResult);
                        const history = JSON.parse(localStorage.getItem(CALC_HISTORY_KEY)) || [];
                        history.unshift({ exp: formatForDisplay(currentExpression.replace(/\*/g, 'Ã—')), res: formatForDisplay(cleanResult.toString()), time: Date.now() });
                        localStorage.setItem(CALC_HISTORY_KEY, JSON.stringify(history.slice(0, 50)));
                        currentExpression = cleanResult.toString();
                    }
                } 
                updateCalcDisplay(); 
            } 
        });
        historyBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            renderHistory();
            historyPanel.style.display = historyPanel.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', () => { if (historyPanel) historyPanel.style.display = 'none'; });
        historyPanel.addEventListener('click', e => e.stopPropagation());
        // --- CALCULATOR LOGIC END ---

        // --- NEW JOURNAL ENTRY GUIDE (AI-POWERED) ---
        const [percentMainEl, percentValEl, percentResultEl, addBtn, subBtn] = [document.getElementById('percent-main-number'), document.getElementById('percent-value'), document.getElementById('percent-result-box'), document.getElementById('percent-add'), document.getElementById('percent-subtract')];
        const calculatePercentage = (mode = '') => { const main = parseFloat(percentMainEl.value) || 0; let pNum = parseFloat(percentValEl.value || '0'); if (isNaN(pNum)) { percentResultEl.textContent = 'Invalid Percentage'; return; } const pVal = main * (pNum / 100); if (mode === 'add') percentResultEl.innerHTML = `${main} + ${pNum}% = <strong>${cleanNumber(main + pVal)}</strong>`; else if (mode === 'sub') percentResultEl.innerHTML = `${main} - ${pNum}% = <strong>${cleanNumber(main - pVal)}</strong>`; else percentResultEl.innerHTML = `${pNum}% of ${main} is <strong>${cleanNumber(pVal)}</strong>`; };
        [percentMainEl, percentValEl].forEach(el => el.addEventListener('input', () => calculatePercentage())); addBtn.addEventListener('click', () => calculatePercentage('add')); subBtn.addEventListener('click', () => calculatePercentage('sub'));
        const [oldRatioEl, newShareEl, newRatioResultEl] = [document.getElementById('admission-old-ratio'), document.getElementById('admission-new-share'), document.getElementById('admission-result-box')];
        const gcd = (a, b) => b ? gcd(b, a % b) : a;
        const calculateNewRatio = () => { const oldParts = oldRatioEl.value.split(':').map(p => parseInt(p.trim())).filter(p => p > 0 && !isNaN(p)); if (oldParts.length === 0) { newRatioResultEl.textContent = 'Enter a valid old ratio.'; return; } let shareVal = newShareEl.value.trim() || '0'; let num = 0, den = 1; if (shareVal.endsWith('%')) { [num, den] = [parseFloat(shareVal), 100]; } else if (shareVal.includes('/')) { [num, den] = shareVal.split('/').map(p => parseFloat(p.trim())); } else { let v = parseFloat(shareVal); if (v >= 1) { [num, den] = [v, 100]; } else { [num, den] = [v, 1]; } } if (isNaN(num) || isNaN(den) || den === 0 || (num / den) <= 0 || (num / den) >= 1) { newRatioResultEl.textContent = 'Invalid share value.'; return; } const c = gcd(num, den); num /= c; den /= c; const remainingNumerator = den - num; const oldSum = oldParts.reduce((a, b) => a + b, 0); let newParts = oldParts.map(p => p * remainingNumerator); newParts.push(oldSum * num); const commonFactor = newParts.reduce(gcd); const finalRatio = newParts.map(p => p / commonFactor); newRatioResultEl.innerHTML = `New Profit Ratio: <strong>${finalRatio.join(' : ')}</strong>`; };
        [oldRatioEl, newShareEl].forEach(el => el.addEventListener('input', calculateNewRatio));
        const [splitterTotalEl, splitterRatioEl, splitterResultEl] = [document.getElementById('splitter-total'), document.getElementById('splitter-ratio'), document.getElementById('splitter-result-box')];
        const calculateRatioSplit = () => { const total = parseFloat(splitterTotalEl.value) || 0; const ratioParts = splitterRatioEl.value.split(':').map(p => parseFloat(p.trim())).filter(p => p > 0 && !isNaN(p)); if (ratioParts.length === 0) { splitterResultEl.textContent = "Enter a valid ratio."; return; } const sumRatio = ratioParts.reduce((a, b) => a + b, 0); if (sumRatio === 0) { splitterResultEl.textContent = "Ratio sum cannot be zero."; return; } splitterResultEl.innerHTML = "<ul>" + ratioParts.map((p, i) => `<li>Partner ${i + 1}: <strong>${((total * p) / sumRatio).toFixed(2)}</strong></li>`).join('') + "</ul>"; };
        [splitterTotalEl, splitterRatioEl].forEach(el => el.addEventListener('input', calculateRatioSplit));

        // --- INITIAL APP STARTUP ---
        showView('app-homescreen');
        renderNotesMenu();
        updateCalcDisplay();
        calculatePercentage();
        calculateNewRatio();
        calculateRatioSplit();
    });
    </script>
</body>
</html>