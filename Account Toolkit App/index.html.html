<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Accounts Toolkit — Hasan</title>
    
    <!-- ICON ADDED HERE -->
    <link rel="icon" type="image/png" href="assets/icon.png">

    <!-- PWA and Mobile-Friendly Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href='data:application/manifest+json,{
        "name": "Accounts Toolkit",
        "short_name": "AccToolkit",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#000000",
        "theme_color": "#000000",
        "description": "An all-in-one toolkit for commerce students.",
        "icons": [{
            "src": "https://www.google.com/s2/favicons?domain=google.com&sz=192",
            "sizes": "192x192",
            "type": "image/png"
        }]
    }'>

    <style>
        /* 1. Global Styles & Theme */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        :root {
            --font-primary: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --bg-color: #000000;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #3385ff;
            --btn-dark-bg: #333333;
            --btn-op-bg: #2E3A48;
            --radius-main: 50px;
            --transition-fast: 0.2s;
            --transition-smooth: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-primary);
            color: var(--text-primary);
            background-color: var(--bg-color);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none; -webkit-user-select: none;
            display: flex; flex-direction: column;
        }
        
        /* Animation Keyframes */
        @keyframes slideUpFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* 2. Main App Structure & Transitions */
        .app-container { flex: 1; min-height: 0; position: relative; perspective: 1500px; }
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 20px 16px 20px 16px;
            overflow-y: auto;
            visibility: hidden; opacity: 0;
            transform: translateY(15px) scale(0.98);
            transition: opacity var(--transition-smooth), transform var(--transition-smooth);
            display: flex; flex-direction: column; align-items: center;
        }
        .view.active { visibility: visible; opacity: 1; transform: translateY(0) scale(1); }
        .view-content { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; }

        /* 3. ENHANCED DYNAMIC HEADER */
        .app-header {
            position: relative; background-color: var(--bg-color); z-index: 101; flex-shrink: 0; text-align: center;
            padding: 20px 16px; transition: padding var(--transition-smooth), background-color 0.5s; border-bottom: 1px solid transparent;
        }
        .app-header.header-scrolled { padding: 10px 16px; backdrop-filter: blur(10px); background-color: rgba(0,0,0,0.7); border-bottom: 1px solid #222; }
        .header-title-container { display: flex; flex-direction: column; align-items: center; width: 100%; position: relative;}
        .header-title { font-size: 1.8rem; font-weight: 600; transition: font-size var(--transition-smooth); }
        .header-subtitle { font-size: 0.8rem; color: var(--text-secondary); transition: opacity var(--transition-smooth), font-size var(--transition-smooth), display 0s; }
        .app-header.header-scrolled .header-title { font-size: 1.3rem; }
        .app-header.header-scrolled .header-subtitle { opacity: 0; font-size: 0.6rem; }
        .btn-back { background: none; border: none; color: var(--text-primary); cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; opacity: 0; pointer-events: none; transition: background var(--transition-smooth), opacity var(--transition-smooth); position: absolute; left: 0px; top: 50%; transform: translateY(-50%); z-index: 102; }
        .btn-back:hover { background: var(--btn-dark-bg); }
        body[data-active-view^="view-"] .btn-back { opacity: 1; pointer-events: auto; }
        
        /* 4. Homescreen Icons */
        #app-homescreen .view-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 20px; padding: 0px 8px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; gap: 12px; cursor: pointer; text-decoration: none; color: var(--text-primary); transition: transform var(--transition-fast); animation: slideUpFadeIn 0.5s both; }
        .app-icon:nth-child(1) { animation-delay: 0.1s; } .app-icon:nth-child(2) { animation-delay: 0.15s; }
        .app-icon:nth-child(3) { animation-delay: 0.2s; } .app-icon:nth-child(4) { animation-delay: 0.25s; }
        .app-icon:nth-child(5) { animation-delay: 0.3s; } 
        .app-icon:active { transform: scale(0.95); }
        .app-icon .icon-visual { width: 70px; height: 70px; border-radius: 20px; background-color: var(--btn-dark-bg); display: flex; align-items: center; justify-content: center; font-size: 2.2rem; transition: all var(--transition-smooth); }
        .app-icon:hover .icon-visual { background-color: var(--accent-blue); color: white; transform: scale(1.1); box-shadow: 0 4px 15px rgba(51, 133, 255, 0.4); }
        .app-icon .icon-label { font-size: 0.8rem; font-weight: 500; text-align: center; }

        /* 5. Tool Card & Components */
        .tool-card { padding: 16px; background: #1c1c1c; border-radius: 16px; width: 100%; transition: box-shadow 0.3s; animation: slideUpFadeIn 0.4s both; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
        input, select, textarea { width: 100%; padding: 14px 18px; border-radius: 12px; border: none; background-color: var(--btn-dark-bg); color: var(--text-primary); font-family: var(--font-primary); font-size: 1rem; }
        input:focus, textarea:focus, select:focus { outline: 2px solid var(--accent-blue); }
        .result-box { background: var(--btn-dark-bg); padding: 16px; border-radius: 12px; margin-top: 16px; font-weight: 500; word-wrap: break-word; line-height: 1.7; }
        .btn { padding: 10px 16px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer; border: none; background: var(--accent-blue); color: white; transition: transform 0.2s, filter 0.2s; }
        
        /* 6. NOTES SECTION */
        .notes-menu-container .notes-menu-item { background: var(--btn-dark-bg); padding: 25px 20px; border-radius: 16px; text-align: center; font-size: 1.3rem; font-weight: 600; cursor: pointer; transition: transform var(--transition-smooth), background var(--transition-smooth); animation: slideUpFadeIn 0.5s both; }
        .notes-menu-item:nth-child(1) { animation-delay: 0.1s; } .notes-menu-item:nth-child(2) { animation-delay: 0.2s; } .notes-menu-item:nth-child(3) { animation-delay: 0.3s; }
        .notes-menu-item:hover { background: var(--accent-blue); transform: translateY(-5px); }
        .notes-subcategory-card { margin-bottom: 20px; background: #1c1c1c; border-radius: 16px; padding: 16px; animation: slideUpFadeIn 0.5s both; }
        .notes-subcategory-title { font-size: 1.5rem; color: var(--accent-blue); margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; text-align: center; }
        .notes-columns-container { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .notes-columns-container.side-by-side { grid-template-columns: 1fr 1fr; }
        .notes-column h4 { text-align: center; font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 10px; }
        .notes-list { list-style: none; padding: 0;}
        .notes-list li { background: var(--btn-dark-bg); padding: 10px 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; line-height: 1.4;}
        /* NOTES BUG FIX HERE */
        .notes-list li span { flex-grow: 1; word-break: break-word; margin-right: 8px; }
        .delete-note-btn { background:none; border:none; cursor:pointer; color: #ff4d4d; font-size: 1.2rem; flex-shrink: 0; margin-left: 8px;}
        .add-note-form { display: flex; gap: 10px; margin-top: 15px; }
        #custom-notes-textarea { min-height: 300px; height: 70vh; resize: vertical; }

        /* 7. MODIFIED CALCULATOR SECTION */
        #view-calculator .view-content { display: flex; flex-direction: column; flex-grow: 1; height: 100%; justify-content: flex-end; gap: 10px; }
        #calculator-display { text-align: right; padding: 16px 8px; flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; overflow: hidden; }
        #calculator-expression-container { min-height: 55px; display: flex; justify-content: flex-end; align-items: center;}
        #calculator-expression { font-size: 3rem; color: var(--text-primary); font-weight: 500; word-break: break-all; }
        #cursor { width: 2px; height: 3rem; background-color: var(--accent-blue); animation: blink 1s step-end infinite; margin-left: 2px; }
        #calculator-preview { font-size: 1.5rem; min-height: 1.3em; color: var(--text-secondary); }
        #calculator-controls { display: flex; justify-content: space-around; padding: 10px 0; flex-shrink: 0; }
        #calculator-controls button { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; opacity: 0.7; }
        #history-panel { position: absolute; bottom: 0; right: 0; width: 100%; background-color: #1c1c1c; padding: 16px; border-radius: 16px 16px 0 0; display: none; z-index: 5; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); }
        #history-panel ul { list-style: none; text-align: right; font-size: 1.2rem; max-height: 150px; overflow-y: auto; padding:0; }
        #calculator-buttons { position: relative; display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; padding: 16px 0px; flex-shrink: 0; }
        .calc-btn { width: 100%; aspect-ratio: 1/1; border-radius: 50%; border: none; font-size: 1.8rem; font-weight: 500; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: filter 0.1s, transform 0.1s; }
        .calc-btn:active { transform: scale(0.95); filter: brightness(1.2); }
        .btn-num { background-color: var(--btn-dark-bg); color: var(--text-primary); }
        .btn-op, .btn-special { background-color: var(--btn-op-bg); color: var(--accent-blue); }
        .btn-equal { background-color: var(--accent-blue); color: white; font-size: 2rem;}
        @media (max-height: 720px) { .calc-btn { font-size: 1.5rem; } #calculator-expression {font-size: 2.5rem;} #cursor {height: 2.5rem;} }

    </style>
</head>
<body data-active-view="app-homescreen">

    <header class="app-header" id="app-header">
        <div class="header-title-container">
            <button class="btn-back" id="back-button" aria-label="Go Back">‹</button>
            <h1 class="header-title" id="header-title">Accounts Toolkit</h1>
            <span class="header-subtitle" id="header-subtitle">Made By Hasan Patel</span>
        </div>
    </header>

    <div class="app-container">
        <!-- Homescreen -->
        <main id="app-homescreen" class="view active">
            <div class="view-content">
                <a class="app-icon" href="#" data-view="view-calculator"><div class="icon-visual">🧮</div><span class="icon-label">Calculator</span></a>
                <a class="app-icon" href="#" data-view="view-percentage"><div class="icon-visual">📈</div><span class="icon-label">Percentage</span></a>
                <a class="app-icon" href="#" data-view="view-new-ratio"><div class="icon-visual">🤝</div><span class="icon-label">New Ratio</span></a>
                <a class="app-icon" href="#" data-view="view-divider"><div class="icon-visual">📊</div><span class="icon-label">Ratio Divider</span></a>
                <a class="app-icon" href="#" data-view="view-notes"><div class="icon-visual">📝</div><span class="icon-label">Notes</span></a>
            </div>
        </main>
        
        <!-- All Tool Sections HTML -->
        <section id="view-calculator" class="view">
            <div class="view-content">
                <div id="calculator-display">
                    <div id="calculator-expression-container">
                        <div id="calculator-expression">0</div>
                        <div id="cursor"></div>
                    </div>
                    <div id="calculator-preview"></div>
                </div>
                <div id="calculator-controls"><button id="history-btn">🕒</button></div>
                <div id="calculator-buttons">
                    <div id="history-panel"><ul></ul></div>
                    <button class="calc-btn btn-special" data-action="clear">AC</button><button class="calc-btn btn-special" data-action="backspace">⌫</button><button class="calc-btn btn-special" data-action="negate">+/-</button><button class="calc-btn btn-op" data-value="/">÷</button>
                    <button class="calc-btn btn-num" data-value="7">7</button><button class="calc-btn btn-num" data-value="8">8</button><button class="calc-btn btn-num" data-value="9">9</button><button class="calc-btn btn-op" data-value="*">×</button>
                    <button class="calc-btn btn-num" data-value="4">4</button><button class="calc-btn btn-num" data-value="5">5</button><button class="calc-btn btn-num" data-value="6">6</button><button class="calc-btn btn-op" data-value="-">−</button>
                    <button class="calc-btn btn-num" data-value="1">1</button><button class="calc-btn btn-num" data-value="2">2</button><button class="calc-btn btn-num" data-value="3">3</button><button class="calc-btn btn-op" data-value="+">+</button>
                    <button class="calc-btn btn-special" data-value="%">%</button><button class="calc-btn btn-num" data-value="0">0</button><button class="calc-btn btn-num" data-value=".">.</button><button class="calc-btn btn-equal" data-action="=">=</button>
                </div>
            </div>
        </section>
        <section id="view-percentage" class="view"><div class="view-content"><div class="tool-card"><h2>Percentage</h2><div class="form-group"><label for="percent-main-number">Number</label><input id="percent-main-number" type="number" inputmode="decimal" placeholder="e.g., 1000"></div><div class="form-group"><label for="percent-value">Percentage</label><input id="percent-value" type="text" inputmode="decimal" placeholder="e.g., 10"></div><div id="percent-actions" style="display:flex; gap:10px;"><button class="btn" id="percent-add" style="width:100%;">Add %</button><button class="btn" id="percent-subtract" style="width:100%;">Subtract %</button></div><div id="percent-result-box" class="result-box">Result will show here</div></div></div></section>
        <section id="view-new-ratio" class="view"><div class="view-content"><div class="tool-card"><h2>New Profit Ratio</h2><div class="form-group"><label for="admission-old-ratio">Old Ratio</label><input id="admission-old-ratio" type="text" placeholder="e.g., 3:1"></div><div class="form-group"><label for="admission-new-share">New Partner's Share</label><input id="admission-new-share" type="text" placeholder="e.g., 1/5 or 20%"></div><div id="admission-result-box" class="result-box">Result will show here</div></div></div></section>
        <section id="view-divider" class="view"><div class="view-content"><div class="tool-card"><h2>Ratio Divider</h2><div class="form-group"><label for="splitter-total">Total Amount</label><input id="splitter-total" type="number" inputmode="decimal" placeholder="e.g., 1000"></div><div class="form-group"><label for="splitter-ratio">Ratio</label><input id="splitter-ratio" type="text" placeholder="e.g., 2:3:5"></div><div id="splitter-result-box" class="result-box">Result will show here</div></div></div></section>

        <!-- NOTES VIEWS -->
        <section id="view-notes" class="view"><div class="view-content notes-menu-container" id="notes-menu-container"></div></section>
        <section id="view-notes-details" class="view"><div class="view-content" id="notes-details-container"></div></section>
        <section id="view-notes-custom" class="view"><div class="view-content"><div class="tool-card"><h2 style="font-size: 1.5rem;">My Custom Notes</h2><textarea id="custom-notes-textarea" placeholder="Write your formulas, tricks, or anything you want to remember here... Your notes will be saved automatically."></textarea></div></div></section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const body = document.body;
        const appHeader = document.getElementById('app-header');
        const headerTitle = document.getElementById('header-title');
        const headerSubtitle = document.getElementById('header-subtitle');

        const viewTitles = {
            'app-homescreen': 'Accounts Toolkit',
            'view-calculator': 'Calculator',
            'view-percentage': 'Percentage Tool',
            'view-new-ratio': 'New Profit Ratio',
            'view-divider': 'Ratio Divider',
            'view-notes': 'Notes',
            'view-notes-details': 'Notes',
            'view-notes-custom': 'My Custom Notes'
        };
        
        function handleScroll() {
            if (this.scrollTop > 10) appHeader.classList.add('header-scrolled');
            else appHeader.classList.remove('header-scrolled');
        }
        
        const vibrate = () => { if (window.navigator.vibrate) window.navigator.vibrate(10); };
        
        const showView = (viewId, params = {}) => {
            vibrate(); 
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
                view.removeEventListener('scroll', handleScroll);
            });
            const view = document.getElementById(viewId);
            if(view) {
                view.classList.add('active');
                view.scrollTop = 0; 
                view.addEventListener('scroll', handleScroll);
            }

            headerTitle.textContent = viewTitles[viewId] || 'Accounts Toolkit';
            headerSubtitle.style.display = viewId === 'app-homescreen' ? 'block' : 'none';

            body.dataset.activeView = viewId;
            if (body.dataset.activeView === 'app-homescreen') appHeader.classList.remove('header-scrolled');
            if (viewId === 'view-notes-details') renderNoteDetails(params.category);
            if (viewId === 'view-notes-custom') renderCustomNotes();
        };

        document.querySelectorAll('[data-view]').forEach(icon => { icon.addEventListener('click', (e) => { e.preventDefault(); showView(icon.dataset.view); }); });
        
        document.getElementById('back-button').addEventListener('click', () => {
             const currentView = body.dataset.activeView;
             if (currentView === 'view-notes-details' || currentView === 'view-notes-custom') showView('view-notes');
             else showView('app-homescreen');
        });

        // --- NOTES LOGIC (FIXED) ---
        const USER_NOTES_KEY = 'acct_notes_user_v2', CUSTOM_NOTES_KEY = 'acct_custom_notes_v1';
        let userNotes = JSON.parse(localStorage.getItem(USER_NOTES_KEY)) || {};
        
        const defaultNotes = {
            "Final Accounts": {
                "Trading Account": { debit: ["To Opening Stock", "To Purchases\n   Less: Purchases Return", "To Carriage Inwards", "To Freight", "To Wages (Direct)", "To Power & Fuel", "To Factory Rent", "To Factory Lighting", "To Royalty (Production related)", "To Octroi & Import Duty", "To Manufacturing Expenses", "To Dock Charges", "To Clearing Charges", "To Motive Power", "To Gas, Water & Steam", "To Coal, Oil & Fuel", "To Productive Expenses", "To Direct Expenses"], credit: ["By Sales\n   Less: Sales Return", "By Closing Stock", "By Goods Sent on Consignment"] },
                "Profit & Loss Account": { debit: ["To Office Rent", "To Office Lighting", "To Office Expenses", "To Insurance", "To Salaries", "To Wages (Indirect)", "To Postage", "To Telephone Expenses", "To Telegram Expenses", "To Printing & Stationery", "To Trade Expenses", "To Travelling Expenses", "To Conveyance", "To Carriage Outwards", "To Advertisement", "To Discount Allowed", "To Bad Debts", "To Repairs", "To Depreciation", "To Interest Paid", "To Commission Allowed", "To Bank Charges", "To Legal Expenses", "To Selling Expenses", "To Distribution Expenses", "To Packing Charges", "To General Expenses", "To Net Profit c/d"], credit: ["By Gross Profit b/d", "By Discount Received", "By Bad Debts Recovered", "By Commission Received", "By Rent Received", "By Interest Received", "By Dividend Received", "By Profit on Sale of Asset", "By Net Loss c/d"] },
                "Balance Sheet": { liabilities: ["Capital\nAdd: Net Profit\nLess: Drawings", "Reserve & Surplus", "Loans (Long Term)", "Debentures", "Bills Payable", "Creditors", "Outstanding Expenses", "Bank Overdraft", "Provision for Taxation", "Proposed Dividend", "General Reserve", "Provision for Doubtful Debts", "Contingent Liabilities"], assets: ["Goodwill", "Patents", "Trademarks", "Copyright", "Buildings", "Plant & Machinery", "Furniture", "Investments", "Debtors\nLess: Provision for Doubtful Debts", "Bills Receivable", "Closing Stock", "Prepaid Expenses", "Outstanding Income", "Accrued Income", "Cash in Hand", "Cash at Bank", "Loose Tools", "Vehicles", "Land"] }
            },
            "NPO Final Accounts": {
                "Income & Expenditure A/c": { debit: ["To Salaries", "To Rent", "To Taxes", "To Printing & Stationery", "To Postage", "To Telephone Expenses", "To General Expenses", "To Repairs", "To Depreciation", "To Insurance", "To Wages", "To Audit Fees", "To Honorarium", "To Sports Material Consumed", "To Cultural Program Expenses", "To Match Expenses", "To Tournament Expenses", "To Library Expenses", "To Subscription Paid to Other Clubs", "To Prize Distributed", "To Conveyance Expenses", "To Entertainment Expenses", "To Loss on Sale of Asset", "To Miscellaneous Expenses", "To Surplus transferred to Capital Fund"], credit: ["By Subscriptions", "By Entrance Fees", "By Donations (Revenue)", "By Donations for General Purpose", "By Life Membership Fees (Revenue treatment if small)", "By Legacies", "By Interest Received", "By Dividend Received", "By Rent Received", "By Sale of Old Newspapers/Magazines", "By Sale of Sports Material", "By Profit on Sale of Asset", "By Receipts from Entertainment/Concert/Drama/Show", "By Sale of Tickets (Match/Function)", "By Locker Rent", "By Miscellaneous Income", "By Deficit transferred to Capital Fund"] },
                "Balance Sheet": { liabilities: ["Capital Fund / General Fund\nAdd: Surplus\nLess: Deficit", "Life Membership Fees (if treated as capital)", "Entrance Fees (if treated as capital)", "Legacies", "Building Fund", "Library Fund", "Sports Fund", "Prize Fund", "Endowment Fund", "Outstanding Expenses", "Creditors", "Subscription Received in Advance", "Loan", "Bank Overdraft"], assets: ["Cash in Hand", "Cash at Bank", "Investments", "Building", "Furniture", "Sports Material", "Library Books", "Fixed Deposits", "Debtors", "Subscriptions Outstanding", "Accrued Interest", "Outstanding Income", "Prepaid Expenses", "Stock of Stationery", "Stock of Sports Materials", "Stock of Medicines", "Musical Instruments", "Computers", "Vehicles"] }
            }
        };

        function saveUserNotes() { localStorage.setItem(USER_NOTES_KEY, JSON.stringify(userNotes)); }

        function renderNotesMenu() {
            const container = document.getElementById('notes-menu-container');
            container.innerHTML = '';
            Object.keys(defaultNotes).forEach(category => {
                const menuItem = document.createElement('div'); menuItem.className = 'notes-menu-item'; menuItem.textContent = category; menuItem.onclick = () => showView('view-notes-details', { category: category }); container.appendChild(menuItem);
            });
            const customItem = document.createElement('div'); customItem.className = 'notes-menu-item'; customItem.textContent = 'My Custom Notes'; customItem.onclick = () => showView('view-notes-custom'); container.appendChild(customItem);
        }

        function renderNoteDetails(category) {
            const container = document.getElementById('notes-details-container'); container.innerHTML = ''; const categoryData = defaultNotes[category];
            for (const subCategory in categoryData) {
                const subCategoryCard = document.createElement('div'); subCategoryCard.className = 'notes-subcategory-card';
                const sides = Object.keys(categoryData[subCategory]); const subCategoryLower = subCategory.toLowerCase();
                const isSideBySide = ['balance sheet', 'trading account', 'profit & loss account', 'income & expenditure a/c'].some(term => subCategoryLower.includes(term));
                let columnsHTML = sides.map(side => {
                    const defaultItems = categoryData[subCategory][side] || []; const userItems = userNotes?.[category]?.[subCategory]?.[side] || [];
                    const listItemsHTML = defaultItems.map(item => `<li><span>${item.replace(/\n/g, '<br>&nbsp;&nbsp;')}</span></li>`).join('');
                    const userListItemsHTML = userItems.map((item, index) => `<li><span>${item.replace(/\n/g, '<br>&nbsp;&nbsp;')}</span><button class="delete-note-btn" data-category="${category}" data-subcategory="${subCategory}" data-side="${side}" data-index="${index}">×</button></li>`).join('');
                    let headerText = side.charAt(0).toUpperCase() + side.slice(1);
                    if (isSideBySide && subCategoryLower.includes('balance sheet')) { headerText += side === 'liabilities' ? ' (Cr.)' : ' (Dr.)';}
                    else if (isSideBySide) { headerText += side === 'credit' ? ' (Cr.)' : ' (Dr.)';}
                    return `<div class="notes-column"><h4>${headerText}</h4><ul class="notes-list">${listItemsHTML}${userListItemsHTML}</ul><form class="add-note-form" data-category="${category}" data-subcategory="${subCategory}" data-side="${side}"><input type="text" placeholder="Add custom entry..." required><button type="submit" class="btn">+</button></form></div>`;
                }).join('');
                subCategoryCard.innerHTML = `<h3 class="notes-subcategory-title">${subCategory}</h3><div class="notes-columns-container ${isSideBySide ? 'side-by-side' : ''}">${columnsHTML}</div>`;
                container.appendChild(subCategoryCard);
            }
        }
        
        function renderCustomNotes() {
            const textarea = document.getElementById('custom-notes-textarea'); textarea.value = localStorage.getItem(CUSTOM_NOTES_KEY) || ''; textarea.oninput = () => { localStorage.setItem(CUSTOM_NOTES_KEY, textarea.value); };
        }

        document.getElementById('notes-details-container').addEventListener('submit', (e) => {
            if (e.target.classList.contains('add-note-form')) {
                e.preventDefault(); const input = e.target.querySelector('input'); const newItem = input.value.trim(); if (!newItem) return;
                const { category, subcategory, side } = e.target.dataset;
                if (!userNotes[category]) userNotes[category] = {}; if (!userNotes[category][subcategory]) userNotes[category][subcategory] = {}; if (!userNotes[category][subcategory][side]) userNotes[category][subcategory][side] = [];
                userNotes[category][subcategory][side].push(newItem); saveUserNotes(); renderNoteDetails(category); input.value = '';
            }
        });
        
        document.getElementById('notes-details-container').addEventListener('click', (e) => {
             if (e.target.classList.contains('delete-note-btn')) {
                 const { category, subcategory, side, index } = e.target.dataset;
                 userNotes[category][subcategory][side].splice(parseInt(index, 10), 1); saveUserNotes(); renderNoteDetails(category);
             }
        });

        // --- ALL OTHER TOOLS LOGIC ---
        const cleanNumber = (num) => parseFloat(num.toPrecision(15));
        
        // MODIFIED Calculator
        const [calcExpressionEl, calcPreviewEl, historyBtn, historyPanel] = [document.getElementById('calculator-expression'), document.getElementById('calculator-preview'), document.getElementById('history-btn'), document.getElementById('history-panel')];
        let currentExpression = '0'; 
        const CALC_HISTORY_KEY = 'acct_calc_history_v1';
        const safeEval = (expr) => { try { if(/[^0-9\.\+\-\*\/\(\)\s%]/.test(expr)) return ''; let sanitized = expr.replace(/(\d*\.?\d+)%/g, '($1/100)'); return new Function('return ' + sanitized)(); } catch { return ''; } }; 
        const formatForDisplay = (str) => str.replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
        const renderHistory = () => {
            const history = (JSON.parse(localStorage.getItem(CALC_HISTORY_KEY)) || []).filter(item => Date.now() - item.time < 24 * 60 * 60 * 1000);
            localStorage.setItem(CALC_HISTORY_KEY, JSON.stringify(history));
            historyPanel.querySelector('ul').innerHTML = history.length ? history.map(h => `<li>${h.exp} = ${h.res}</li>`).join('') : '<li>No recent history</li>';
        };
        const updateCalcDisplay = () => { 
            calcExpressionEl.textContent = formatForDisplay(currentExpression.replace(/\*/g, '×')); 
            let previewResult = safeEval(currentExpression);
            calcPreviewEl.textContent = previewResult !== '' ? `= ${formatForDisplay(cleanNumber(previewResult).toString())}` : '';
        }; 
        document.getElementById('calculator-buttons').addEventListener('click', (e) => { 
            vibrate(); 
            const target = e.target.closest('.calc-btn');
            if (target) { 
                const { value, action } = target.dataset; 
                if (currentExpression === '0' && value && value !== '.') currentExpression = ''; 
                if (value) currentExpression += value; 
                if (action === 'clear') currentExpression = '0'; 
                if (action === 'backspace') currentExpression = currentExpression.slice(0, -1) || '0'; 
                if (action === 'negate') {
                    if (currentExpression !== '0') {
                        if (currentExpression.startsWith('-')) { currentExpression = currentExpression.substring(1); }
                        else { currentExpression = '-' + currentExpression; }
                    }
                }
                if (action === '=') { 
                    const finalResult = safeEval(currentExpression); 
                    if (finalResult !== '') {
                        const cleanResult = cleanNumber(finalResult);
                        const history = JSON.parse(localStorage.getItem(CALC_HISTORY_KEY)) || [];
                        history.unshift({ exp: formatForDisplay(currentExpression.replace(/\*/g, '×')), res: formatForDisplay(cleanResult.toString()), time: Date.now() });
                        localStorage.setItem(CALC_HISTORY_KEY, JSON.stringify(history.slice(0, 50)));
                        currentExpression = cleanResult.toString();
                    }
                } 
                updateCalcDisplay(); 
            } 
        });
        historyBtn.addEventListener('click', (e) => {
            e.stopPropagation(); renderHistory(); historyPanel.style.display = historyPanel.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', () => { if(historyPanel) historyPanel.style.display = 'none'; });
        historyPanel.addEventListener('click', e => e.stopPropagation());

        // Percentage Tool
        const [percentMainEl, percentValEl, percentResultEl, addBtn, subBtn] = [document.getElementById('percent-main-number'), document.getElementById('percent-value'), document.getElementById('percent-result-box'), document.getElementById('percent-add'), document.getElementById('percent-subtract')]; 
        const calculatePercentage = (mode = '') => { const main = parseFloat(percentMainEl.value) || 0; let pNum = parseFloat(percentValEl.value || '0'); if (isNaN(pNum)) { percentResultEl.textContent = 'Invalid Percentage'; return; } const pVal = main * (pNum / 100); if (mode === 'add') percentResultEl.innerHTML = `${main} + ${pNum}% = <strong>${cleanNumber(main + pVal)}</strong>`; else if (mode === 'sub') percentResultEl.innerHTML = `${main} - ${pNum}% = <strong>${cleanNumber(main - pVal)}</strong>`; else percentResultEl.innerHTML = `${pNum}% of ${main} is <strong>${cleanNumber(pVal)}</strong>`; }; 
        [percentMainEl, percentValEl].forEach(el => el.addEventListener('input', () => calculatePercentage())); addBtn.addEventListener('click', () => calculatePercentage('add')); subBtn.addEventListener('click', () => calculatePercentage('sub'));
        
        // New Ratio Tool
        const [oldRatioEl, newShareEl, newRatioResultEl] = [document.getElementById('admission-old-ratio'), document.getElementById('admission-new-share'), document.getElementById('admission-result-box')]; 
        const gcd = (a, b) => b ? gcd(b, a % b) : a;
        const calculateNewRatio = () => { const oldParts=oldRatioEl.value.split(':').map(p=>parseInt(p.trim())).filter(p=>p>0 && !isNaN(p)); if(oldParts.length===0){ newRatioResultEl.textContent='Enter a valid old ratio.'; return; } let shareVal=newShareEl.value.trim()||'0'; let num=0, den=1; if(shareVal.endsWith('%')){ [num,den]=[parseFloat(shareVal),100]; } else if(shareVal.includes('/')){ [num,den]=shareVal.split('/').map(p=>parseFloat(p.trim())); } else{ let v=parseFloat(shareVal); if(v>=1){[num,den]=[v,100];} else {[num,den]=[v,1];} } if(isNaN(num) || isNaN(den) || den===0 || (num/den)<=0 || (num/den)>=1){ newRatioResultEl.textContent='Invalid share value.'; return; } const c=gcd(num,den); num/=c; den/=c; const remainingNumerator = den-num; const oldSum=oldParts.reduce((a,b)=>a+b,0); let newParts = oldParts.map(p => p * remainingNumerator); newParts.push(oldSum * num); const commonFactor = newParts.reduce(gcd); const finalRatio = newParts.map(p=>p/commonFactor); newRatioResultEl.innerHTML=`New Profit Ratio: <strong>${finalRatio.join(' : ')}</strong>`; }; 
        [oldRatioEl, newShareEl].forEach(el => el.addEventListener('input', calculateNewRatio));

        // Ratio Divider
        const [splitterTotalEl, splitterRatioEl, splitterResultEl] = [document.getElementById('splitter-total'), document.getElementById('splitter-ratio'), document.getElementById('splitter-result-box')]; 
        const calculateRatioSplit = () => { const total = parseFloat(splitterTotalEl.value) || 0; const ratioParts = splitterRatioEl.value.split(':').map(p => parseFloat(p.trim())).filter(p => p > 0 && !isNaN(p)); if(ratioParts.length === 0){ splitterResultEl.textContent = "Enter a valid ratio."; return;} const sumRatio = ratioParts.reduce((a, b) => a + b, 0); if(sumRatio === 0) { splitterResultEl.textContent = "Ratio sum cannot be zero."; return;} splitterResultEl.innerHTML = "<ul>" + ratioParts.map((p, i) => `<li>Partner ${i + 1}: <strong>${((total * p) / sumRatio).toFixed(2)}</strong></li>`).join('') + "</ul>"; }; 
        [splitterTotalEl, splitterRatioEl].forEach(el => el.addEventListener('input', calculateRatioSplit));

        // --- INITIAL APP STARTUP ---
        showView('app-homescreen');
        renderNotesMenu();
        updateCalcDisplay();
        calculatePercentage();
        calculateNewRatio();
        calculateRatioSplit();
    });
    </script>
</body>
</html>